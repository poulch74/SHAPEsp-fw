<html>
   <head>
   <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=2.0'>

   <style  type='text/css'>

      body { font: 100% verdana, arial, sans-serif; background-color: #fff; margin: 10px; }
      form { font: 100% verdana, arial, sans-serif; background-color: #fff; margin: 10px; }

      #tabs { padding: 10px 10px 4px 0px; margin: 0px; clear: both; }
      #tabs-title { padding: 10px 10px 4px 10px; margin: 0px; clear: both; border-bottom: 1px solid #fc0;}

      #tabs-title { background: #fff; height: 20px; font: 12px verdana, arial, sans-serif; }

      .tab-title { border: 1px solid #fc0; cursor: pointer; background: #fc0; margin-right: 3px; padding: 4px 5px; list-style: none; float: left; }

      .selected-li { border-bottom: 1px solid #fff; border-right: 1px solid #fc0; border-left: 1px solid #fc0; border-top: 1px solid #fc0; background: #fff; }

      #tabs-title li:hover { background: #fff; }

      .tab { padding: 1px; display: none; background: #fff; text-align: justify; }

      .selected { display: block; }

      .maintable { width:100%; border-spacing: 0px; border-right: 1px solid #fc0; border-left: 1px solid #fc0;}

      #sidebar { float: left; }

      #container { width: 100%; }

      .ptitle { padding: 3px; }

   .button24 {
   display: inline-block;
   color: white;
   text-decoration: none;
   height: 2em;
   padding: .2em 2em;
   outline: none;
   border-width: 1px 0;
   border-style: solid none;
   border-color: #FFCC00 #000 #D77206;
   border-radius: 4px;
   background: linear-gradient(#F3AE0F, #E38916) #E38916;
   transition: 0.2s;
   }
   .button24:hover { background: linear-gradient(#ffcc00, #f5ae00) #ffcc00; }
   .button24:active { background: linear-gradient(#f59500, #ffcc00) #f59500; }


   .itext{ width: 5em; height: 2em; padding: 0 0 0 1em;
           border: 1px solid #fc0; outline: 0; border-radius: 4px;} 

   .ctext{ width: 7em; height: 2em; padding: 0 0 0 1em;
           border: 1px solid #fc0; outline: 0; border-radius: 4px; } 

   .ctext1{ width: 15em; height: 2em; padding: 0 0 0 1em;
           border: 1px solid #fc0; outline: 0; border-radius: 4px; } 

   .div1{display:table;}
   .div2{display:table-row;}
   .div3{display:table-cell; padding: 0 0 5px 10px; font: 12px verdana, arial, sans-serif;}

   </style>
  
   <script type="text/javascript">
      !function(n){'use strict';function t(n,t){var r=(65535&n)+(65535&t);return(n>>16)+(t>>16)+(r>>16)<<16|65535&r}
      function r(n,t){return n<<t|n>>>32-t}function e(n,e,o,u,c,f){return t(r(t(t(e,n),t(u,f)),c),o)}
      function o(n,t,r,o,u,c,f){return e(t&r|~t&o,n,t,u,c,f)}function u(n,t,r,o,u,c,f){return e(t&o|r&~o,n,t,u,c,f)}
      function c(n,t,r,o,u,c,f){return e(t^r^o,n,t,u,c,f)}function f(n,t,r,o,u,c,f){return e(r^(t|~o),n,t,u,c,f)}
      function i(n,r){n[r>>5]|=128<<r%32,n[14+(r+64>>>9<<4)]=r;var e,i,a,d,h,l=1732584193,g=-271733879,v=-1732584194,m=271733878;
      for(e=0;e<n.length;e+=16)i=l,a=g,d=v,h=m,g=f(g=f(g=f(g=f(g=c(g=c(g=c(g=c(g=u(g=u(g=u(g=u(g=o(g=o(g=o(g=o(g,v=o(v,m=o(m,l=o(l,g,v,m,n[e],7,-680876936),
      g,v,n[e+1],12,-389564586),l,g,n[e+2],17,606105819),m,l,n[e+3],22,-1044525330),v=o(v,m=o(m,l=o(l,g,v,m,n[e+4],7,-176418897),
      g,v,n[e+5],12,1200080426),l,g,n[e+6],17,-1473231341),m,l,n[e+7],22,-45705983),v=o(v,m=o(m,l=o(l,g,v,m,n[e+8],7,1770035416),
      g,v,n[e+9],12,-1958414417),l,g,n[e+10],17,-42063),m,l,n[e+11],22,-1990404162),v=o(v,m=o(m,l=o(l,g,v,m,n[e+12],7,1804603682),
      g,v,n[e+13],12,-40341101),l,g,n[e+14],17,-1502002290),m,l,n[e+15],22,1236535329),v=u(v,m=u(m,l=u(l,g,v,m,n[e+1],5,-165796510),
      g,v,n[e+6],9,-1069501632),l,g,n[e+11],14,643717713),m,l,n[e],20,-373897302),v=u(v,m=u(m,l=u(l,g,v,m,n[e+5],5,-701558691),
      g,v,n[e+10],9,38016083),l,g,n[e+15],14,-660478335),m,l,n[e+4],20,-405537848),v=u(v,m=u(m,l=u(l,g,v,m,n[e+9],5,568446438),
      g,v,n[e+14],9,-1019803690),l,g,n[e+3],14,-187363961),m,l,n[e+8],20,1163531501),v=u(v,m=u(m,l=u(l,g,v,m,n[e+13],5,-1444681467),
      g,v,n[e+2],9,-51403784),l,g,n[e+7],14,1735328473),m,l,n[e+12],20,-1926607734),v=c(v,m=c(m,l=c(l,g,v,m,n[e+5],4,-378558),
      g,v,n[e+8],11,-2022574463),l,g,n[e+11],16,1839030562),m,l,n[e+14],23,-35309556),v=c(v,m=c(m,l=c(l,g,v,m,n[e+1],4,-1530992060),
      g,v,n[e+4],11,1272893353),l,g,n[e+7],16,-155497632),m,l,n[e+10],23,-1094730640),v=c(v,m=c(m,l=c(l,g,v,m,n[e+13],4,681279174),
      g,v,n[e],11,-358537222),l,g,n[e+3],16,-722521979),m,l,n[e+6],23,76029189),v=c(v,m=c(m,l=c(l,g,v,m,n[e+9],4,-640364487),
      g,v,n[e+12],11,-421815835),l,g,n[e+15],16,530742520),m,l,n[e+2],23,-995338651),v=f(v,m=f(m,l=f(l,g,v,m,n[e],6,-198630844),
      g,v,n[e+7],10,1126891415),l,g,n[e+14],15,-1416354905),m,l,n[e+5],21,-57434055),v=f(v,m=f(m,l=f(l,g,v,m,n[e+12],6,1700485571),
      g,v,n[e+3],10,-1894986606),l,g,n[e+10],15,-1051523),m,l,n[e+1],21,-2054922799),v=f(v,m=f(m,l=f(l,g,v,m,n[e+8],6,1873313359),
      g,v,n[e+15],10,-30611744),l,g,n[e+6],15,-1560198380),m,l,n[e+13],21,1309151649),v=f(v,m=f(m,l=f(l,g,v,m,n[e+4],6,-145523070),
      g,v,n[e+11],10,-1120210379),l,g,n[e+2],15,718787259),m,l,n[e+9],21,-343485551),l=t(l,i),g=t(g,a),v=t(v,d),m=t(m,h);return[l,g,v,m]}
      function a(n){var t,r='',e=32*n.length;for(t=0;t<e;t+=8)r+=String.fromCharCode(n[t>>5]>>>t%32&255);return r}
      function d(n){var t,r=[];for(r[(n.length>>2)-1]=void 0,t=0;t<r.length;t+=1)r[t]=0;var e=8*n.length;for(t=0;t<e;t+=8)r[t>>5]|=(255&n.charCodeAt(t/8))<<t%32;return r}
      function h(n){return a(i(d(n),8*n.length))}function l(n,t){var r,e,o=d(n),u=[],c=[];for(u[15]=c[15]=void 0,o.length>16&&(o=i(o,8*n.length)),r=0;r<16;r+=1)u[r]=909522486^o[r],c[r]=1549556828^o[r];return e=i(u.concat(d(t)),512+8*t.length),a(i(c.concat(e),640))}
      function g(n){var t,r,e='';for(r=0;r<n.length;r+=1)t=n.charCodeAt(r),e+='0123456789abcdef'.charAt(t>>>4&15)+'0123456789abcdef'.charAt(15&t);return e}
      function v(n){return unescape(encodeURIComponent(n))}function m(n){return h(v(n))}function p(n){return g(m(n))}
      function s(n,t){return l(v(n),v(t))}function C(n,t){return g(s(n,t))}
      function A(n,t,r){return t?r?s(t,n):C(t,n):r?m(n):p(n)}'function'==typeof define&&define.amd?define(function(){return A}):
      'object'==typeof module&&module.exports?module.exports=A:n.md5=A}(this);

      var websock;

      function SelectTab(idx)
      {
         var tabStart = parseInt(sessionStorage.getItem("tabStart"));
         var tabCount = parseInt(sessionStorage.getItem("tabCount"));
         if(idx>tabCount) return;
         for (var i = tabStart; i <=tabCount; i++)
         {
            var _tab = document.getElementById("tab"+i);
            var _tabTitle = document.getElementById("tab-title"+i);
            if (idx != i)
            {
               _tab.setAttribute("class", "tab");
               _tabTitle.setAttribute("class", "tab-title");
            }
            else
            {
               _tab.setAttribute("class", "tab selected");
               _tabTitle.setAttribute("class", "tab-title selected-li");
            }
         }
      }

      function getRandomInt(max) { return Math.floor(Math.random() * (max-1)) + 1; }

      function start()
      {
         websock = new WebSocket("ws://" + window.location.hostname + "/ws");
         websock.onopen = function(evt) { console.log('websock open'); };
         websock.onclose = function(evt) { console.log('websock close'); };
         websock.onerror = function(evt) { console.log(evt); };
         websock.onmessage = onMessageHandler;
         if(sessionStorage.getItem("hash")) {
            makelist();
            setTimeout(morestatus,100);
            return;
         }
         sessionStorage.setItem("sessionid", getRandomInt(1000000));
         sessionStorage.setItem("tabStart", 1);
         sessionStorage.setItem("tabCount", 1);
      }

      function onMessageHandler(evt)
      {
         console.log(evt);

         var resp = JSON.parse(evt.data);

         if(resp.action == "auth")
         {
             if(resp.status_auth=='ok')
             {
               makelist();
               setTimeout(morestatus,100);
             }               
             return;
         }

         var resp = JSON.parse(evt.data,function(key,value){
            if(key!='action' && key!='')
               if(document.getElementById(key)!=null) document.getElementById(key).innerHTML = value;
            return value;
         });
      
      };

      function reqauth()
      {
         var paswd = document.getElementById('pwd').value; document.getElementById('pwd').value = '';
         var user = document.getElementById('un').value; document.getElementById('un').value = '';
         var d = "0";
         var hash;
         if(sessionStorage.getItem("sessionid"))
         {
            d = sessionStorage.getItem("sessionid");
            hash = md5(user+paswd+d);
            sessionStorage.setItem("hash", hash);
            document.getElementById('description').innerHTML = hash;
            var msg = { type: "message", auth : hash, text: "sessionid", data : d};
            var smsg = JSON.stringify(msg);
            websock.send(smsg);
         }
      }

      function morestatus()
      {
         var msg = { type: "message", auth: sessionStorage.getItem("hash"), text: "status", id: 0 };
         var smsg = JSON.stringify(msg);
         websock.send(smsg);
         setTimeout(morestatus, 1000);
      }

      function makelist()
      {
         sessionStorage.setItem("tabCount",4);
         var list = document.getElementById("tabs-title");
         list.innerHTML = "<li id='tab-title1' onclick='SelectTab(1);' class='tab-title selected-li'>Status</li> \
                           <li id='tab-title2' onclick='SelectTab(2);' class='tab-title'>Timer</li> \
                           <li id='tab-title3' onclick='SelectTab(3);' class='tab-title'>Settings</li> \
                           <li id='tab-title4' onclick='SelectTab(4);' class='tab-title'>Security</li>";

         var _tab = document.getElementById("tab0");                           
         _tab.setAttribute("class", "tab");

         _tab = document.getElementById("tab1");                           
         _tab.setAttribute("class", "tab selected");
      }


  </script>
  
   </head>

   <body onload="javascript:start();">

   <table class="maintable">

      <tr><td bgcolor='#fc0' style='height:2em; padding:0 0 0 1em' align='left'>SHAPEsp timer v1.0</td></tr>

      <tr>
         <td>
            <ul id="tabs-title">
               <li id="tab-title0" class="tab-title selected-li">Logon</li>
            </ul>

            <div id="tabs">

            <div class="tab selected" id="tab0">

               <div class=div1'>
                  <div class='div2'>
                     <div class='div3'>User:</div>
                     <div class='div3'><input type='text' class='ctext1' name='USERNAME' id='un' maxlength='20' placeholder='user name'></div>
                  </div>
                  <div class='div2'>
                     <div class='div3'>Password:</div>
                     <div class='div3'><input type='password' class='ctext1' name='PASSWORD' id='pwd' maxlength='20' placeholder='password'></div>
                  </div>
                  <div class='div2'>
                     <div class='div3'></div> 
                     <div class='div3'><button  class='button24' onclick="reqauth();">Logon</button></div>
                  </div>
               </div>
            </div>
     
            <div class="tab" id="tab1">
               <div class='div1'>
                  <div class='div2'>
                     <div class="div3">DateTime:</div>
                     <div class="div3"><span id="status_dt">1</span></div>
                  </div>
                  <div class='div2'>
                     <div class="div3">Free Heap :</div>
                     <div class="div3"><span id="status_heap">1</span></div>
                  </div>
                  <div class='div2'>   
                     <div class="div3">Temperature, C:</div>
                     <div class="div3"><span id="status_temp">2</span></div>
                  </div>
                  <div class='div2'>   
                     <div class="div3">Humidity, RH:</div>
                     <div class="div3"><span id="status_hum">3</span></div>
                  </div>
                  <div class='div2'>   
                     <div class="div3">Pressure, mmHg:</div>
                     <div class="div3"><span id="status_pres">4</span></div>
                  </div>
                  <div class='div2'>
                     <div class="div3">WIFI mode:</div>
                     <div class="div3"><span id="status_wifimode">5</span></div>
                  </div>
                  <div class='div2'>
                     <div class="div3">SSID:</div>
                     <div class="div3"><span id="status_wifissid">6</span></div>
                  </div>
                  <div class='div2'>
                     <div class="div3">IP:</div>
                     <div class="div3"><span id="status_wifiip">7</span></div>
                  </div>
                  <div class='div2'>                     
                     <div class="div3">RSSI:</div>
                     <div class="div3"><span id="status_wifirssi">9</span></div>
                  </div>
                  <div class='div2'>                     
                     <div class="div3">Voltage:</div>
                     <div class="div3"><span id="status_voltage">9</span></div>
                  </div>
                  <div class='div2'>                     
                     <div class="div3">Valve mode:</div>
                     <div class="div3"><span id="status_vmode">10</span></div>
                  </div>
                  <div class='div2'>                     
                     <div class="div3">Valve status:</div>
                     <div class="div3"><span id="status_vstatus">11</span></div>
                  </div>
               </div>
            </div>

            <div class="tab" id="tab2">
            </div>

            <div class="tab" id="tab3">
            </div>

            <div class="tab" id="tab4">
            </div>
           </div>

         </td>
      </tr>

      <tr>
         <td bgcolor='#fc0' style='height:2em; padding:0 0 0 1em' align='left'>&nbsp</td>
      </tr>
   </table>  

   <p id='description'> - </p>

   </body>
</html>